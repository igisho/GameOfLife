image: node:20-alpine

variables:
  PROJECT_NAME: "conoway"
  EXT_PORT: "1445"
  INT_PORT: "8080"
  WEB: "https://conway.altky.sk"
  IMAGE: "https://conway.altky.sk/favicon.ico"

stages:
  - build
  - test
  - deploy

before_script:
  - echo "Getting ready"
  - apk add --no-cache python3 make g++ ttf-dejavu
  - node -v && npm -v

build:
  stage: build
  script:
    - echo "Build"
    - npm ci
    - npm run build
  allow_failure: false
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

test:
  stage: test
  script:
    - echo "Typecheck"
    - npm ci
    - npm run typecheck
  allow_failure: true

deploy:
  stage: deploy
  environment:
    name: production
    url: $WEB
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  script:
    - echo "Installing Docker client..."
    - apk add --no-cache docker-cli
    - echo "Deploying to Docker"
    - docker info
    - docker stop $PROJECT_NAME || true
    - docker rm $PROJECT_NAME || true
    - docker build -t $PROJECT_NAME:$CI_COMMIT_SHORT_SHA .
    - docker run -d --name $PROJECT_NAME --net='bridge' -e TZ="Europe/Budapest" -e PORT=$INT_PORT -e HOST_OS="Unraid" -e HOST_HOSTNAME="unraid" -e HOST_CONTAINERNAME=$PROJECT_NAME -l net.unraid.docker.managed=dockerman -l net.unraid.docker.webui="$WEB" -l net.unraid.docker.icon="$IMAGE" -p $EXT_PORT:$INT_PORT/tcp $PROJECT_NAME:$CI_COMMIT_SHORT_SHA
  allow_failure: false
  when: manual
  only:
    - main
